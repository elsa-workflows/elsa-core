image: Previous Visual Studio 2019

environment:
  nodejs_version: "11"
  # AppVeyor installs Java on its build agents by default, but it
  # picks an old version that's not compatible with SonarQube.
  # This brings it up to date.
  JAVA_HOME: "C:\\Program Files\\Java\\jdk13"
  sonarcloud_org_name: elsa-workflows
  sonarcloud_project_name: elsa-core
  sonarcloud_api_key:
    secure: +886yMchgwCvv3Bza9K43mtftx+bAhWS46fF6sihvk9DUq+dxAQZemMDhBcMFp2V

version: 2.0.0-preview6.{build}

init:
  - cmd: git config --global core.autocrlf true

pull_requests:
  do_not_increment_build_number: true

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: '{version}'
  version_prefix: '{version}'
  package_version: '{version}'
  assembly_version: '{version}'
  file_version: '{version}'
  informational_version: '{version}'

cache:
  - src\dashboards\blazor\ElsaDashboard.Application\node_modules
  - '%APPDATA%\npm-cache'

install:
  - ps: >-
      Install-Product node $env:nodejs_version

      cd .\src\dashboards\blazor\ElsaDashboard.Application

      npm install --force

      cd ..\..\..\..\

      dotnet tool install --global dotnet-sonarscanner

before_build:
  - ps: >-
      dotnet-sonarscanner begin `
        /k:$env:sonarcloud_project_name `
        /v:AppVeyor_build_$env:version `
        /o:$env:sonarcloud_org_name `
        /s:$env:APPVEYOR_BUILD_FOLDER\.SonarQube.Analysis.xml `
        /d:sonar.host.url="https://sonarcloud.io" `
        /d:sonar.login=$env:sonarcloud_api_key `
        /d:sonar.cs.xunit.reportsPaths=$env:APPVEYOR_BUILD_FOLDER\**\TestResults\TestResults.xml `
        /d:sonar.cs.opencover.reportsPaths=$env:APPVEYOR_BUILD_FOLDER\**\TestResults\*\coverage.opencover.xml `
        /d:sonar.branch.name=$env:APPVEYOR_REPO_BRANCH

build_script:
  - ps: >-
      cd .\src\dashboards\blazor\ElsaDashboard.Application

      npm run build:css

      cd ..\..\..\..\
      
      dotnet build

test_script:
  - ps: dotnet test --collect:"XPlat Code Coverage" --logger:xunit -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

after_test:
  - ps: dotnet-sonarscanner end /d:sonar.login=$env:sonarcloud_api_key

before_package:
  - ps: dotnet pack Elsa.sln --include-symbols /p:Version=$env:APPVEYOR_BUILD_VERSION

artifacts:
  - path: '**/*.nupkg'
    name: Packages
  - path: '**/TestResults/TestResults.xml'

deploy:
  # Deploy to MyGet on every build (in the appropriate branch)
  - provider: NuGet
    server: https://www.myget.org/F/elsa-2/api/v2/package
    api_key:
      secure: JfESkwmLdWU7dzvoqKPUfMemb00wX8AEYxeHCsYWTX1LfTeECdmKdZxz7IVUpebb
    skip_symbols: true
    on:
      branch: feature/elsa-2.0
  
  # Deploy to NuGet on builds from tags only
  - provider: NuGet
    api_key:
      secure: WC5CCcM5ksWOJbv925FNjv91KsfqHfwEe0A61FMNB27IxvttwJsvBC9XYwK+wQnp
    skip_symbols: true
    on:
      APPVEYOR_REPO_TAG: true
