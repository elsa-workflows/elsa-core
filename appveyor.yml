image: Previous Visual Studio 2019

environment:
  nodejs_version: "11"

version: 2.0.0-preview6.{build}

init:
  - cmd: git config --global core.autocrlf true

pull_requests:
  do_not_increment_build_number: true

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: '{version}'
  version_prefix: '{version}'
  package_version: '{version}'
  assembly_version: '{version}'
  file_version: '{version}'
  informational_version: '{version}'

cache:
  - src\dashboards\blazor\ElsaDashboard.Application\node_modules
  - '%APPDATA%\npm-cache'

install:
  - ps: >-
      Install-Product node $env:nodejs_version

      cd .\src\dashboards\blazor\ElsaDashboard.Application

      npm install --force

      cd ..\..\..\..\

build_script:
  - ps: >-
      cd .\src\dashboards\blazor\ElsaDashboard.Application

      npm run build:css

      cd ..\..\..\..\
      
      dotnet pack Elsa.sln --include-symbols /p:Version=$env:APPVEYOR_BUILD_VERSION

test_script:
  - ps: dotnet test

artifacts:
  - path: '**/*.nupkg'
    name: Packages

deploy:
  # Deploy to MyGet on every build (in the appropriate branch)
  - provider: NuGet
    server: https://www.myget.org/F/elsa-2/api/v2/package
    api_key:
      secure: JfESkwmLdWU7dzvoqKPUfMemb00wX8AEYxeHCsYWTX1LfTeECdmKdZxz7IVUpebb
    skip_symbols: true
    on:
      branch: feature/elsa-2.0
  
  # Deploy to NuGet on builds from tags only
  - provider: NuGet
    api_key:
      secure: WC5CCcM5ksWOJbv925FNjv91KsfqHfwEe0A61FMNB27IxvttwJsvBC9XYwK+wQnp
    skip_symbols: true
    on:
      APPVEYOR_REPO_TAG: true
